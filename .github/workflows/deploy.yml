name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
      - feature/1-woopkassa
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Получаем всю историю для правильной работы с файлами

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build project
        run: yarn build

      - name: Deploy to server via rsync
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key (preserve newlines)
          # Handle both single-line and multi-line key formats
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Verify SSH key format (check for common formats)
          if ! grep -qE "(BEGIN.*PRIVATE KEY|BEGIN RSA PRIVATE KEY|BEGIN OPENSSH PRIVATE KEY)" ~/.ssh/deploy_key; then
            echo "Warning: SSH key format might be incorrect, but continuing..."
            echo "First line of key: $(head -1 ~/.ssh/deploy_key | cut -c1-50)..."
          fi
          
          # Ensure key has proper newlines (some secrets might be single-line)
          if ! grep -q "PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "Error: SSH key does not contain PRIVATE KEY marker"
            echo "Key length: $(wc -c < ~/.ssh/deploy_key) bytes"
            exit 1
          fi
          
          # Add host to known_hosts
          if [ -n "$DEPLOY_HOST" ]; then
            ssh-keyscan -t rsa,ecdsa,ed25519 "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
            chmod 644 ~/.ssh/known_hosts
          fi
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o ConnectTimeout=10 \
            "$DEPLOY_USER@$DEPLOY_HOST" "echo 'SSH connection successful'" || {
            echo "SSH connection failed"
            exit 1
          }
          
          # Define directories
          REMOTE_DIR="/home/ubuntu/inji/server"
          REMOTE_PROJECT_DIR="$REMOTE_DIR/inji-backend"
          
          # Clean remote directory
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$DEPLOY_USER@$DEPLOY_HOST" "rm -rf $REMOTE_DIR && mkdir -p $REMOTE_PROJECT_DIR"
          
          # Copy files (IMPORTANT: use trailing slash to copy contents)
          # This ensures src/ folder is copied correctly
          rsync -avz \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'scripts' \
            --exclude 'dist' \
            --exclude '.env' \
            --exclude 'yarn-error.log' \
            --exclude '*.log' \
            --exclude '.github' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts" \
            ./ "$DEPLOY_USER@$DEPLOY_HOST:$REMOTE_PROJECT_DIR/"
          
          # Verify src directory exists
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$DEPLOY_USER@$DEPLOY_HOST" "test -d $REMOTE_PROJECT_DIR/src && echo '✓ src/ directory exists' || (echo '✗ ERROR: src/ directory missing!' && exit 1)"
          
          # Remove .git if it exists (shouldn't, but just in case)
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$DEPLOY_USER@$DEPLOY_HOST" "rm -rf $REMOTE_PROJECT_DIR/.git"
          
          # Install dependencies, build and restart on server
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$DEPLOY_USER@$DEPLOY_HOST" "cd $REMOTE_PROJECT_DIR && yarn install --production --frozen-lockfile && npx prisma generate && yarn build && yarn start:pm2:prod"
          
          echo "✓ Deployment completed successfully"

